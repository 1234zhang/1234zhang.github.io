---
layout: '[layout]'
title: Schema与数据优化
date: 2020-01-11 10:28:32
tags:
---
# 写在前面的话
本篇主要是《高性能MySQL》，一书的读书笔记。良好的逻辑设计和物理设计是高性能的基石，这往往需要权衡各个方面的各种因素。

# 选择优化的数据类型
选择正确的数据类型对获得更高效的性能至关重要，在进行数据类型选择的时候，主要遵从如下几个原则:
- 更小的通常更好
    一般情况下，应该尽量选择可以正确存储数据的最小数据类型。更小的数据类型通常更快，占用的内存空间更小。在进行查询操作的时候，有更少的I/O操作。
- 简单更好
    简单数据类型操作通常需要更少的CPU内存。例如：整型比字符操作代价更低，因为字符集和校对规则使字符比整型更复杂。在进行设计的时候，我们应该优先选择使用MySQL内建类型(datetime, timestamp)来代替字符串来存储时间，使用整型来存储IP地址
- 尽量避免NULL
    如果使用null的列，对MySQL更难优化，因为可为null的列使得索引和索引统计值都更加复杂。可为null的列会使用更多的存储空间
## 整数类型
分为两种类型的数，整数分为两种，分别是有符号数和无符号数。有符号数和无符号数有相同的存储空间，并具有相同的性能，因此可以根据实际情况选择合适的类型。
MySQL对整数类型指定宽度(例如int(11))，这个对大多数应用是没有意义的，这个的主要目的是为了方便可视化界面的显示，但并不影响数据的存储。所以int(1)和int(11)对于存储和计算来说，是相同的。

## 实数类型
MySQL既支持精确类型又支持非精确类型。FLOAT和DOUBLE类型支持标准的浮点运算进行近似计算。
DECIMAL类型用于存储精确的小数，支持精确计算。因为CPU不支持DECIMAL的直接计算，是MySQL自身实现了DECIMAL的高精度计算。所以在计算性能方面，浮点数运算明显更快。所以我们可以得出的是DECIMAL只是一种存储格式，在计算的时候DECIMAL会转换成DOUBLE类型。
因为需要额外的空间和计算开销，所以应该尽量只在对小数进行精确计算时才使用DECIMAL。但在数据量比较大的时候，可以考虑使用BIGINT代替DECIMAL，这样可以同时避免浮点存储计算不精确和DECIMAL精确计算代价高的缺点。

## 字符串类型
从MySQL4.1开始每个字符串列可以定义自己的字符集和排序规则(校对规则)。
- VARCHAR
    VARCHAR类型用于存储可变长字符串，最常见的字符串数据类型。比定长类型更加节省空间。他只使用必要的空间(越短的字符串使用越少的空间)。
    VARCHAR需要使用1或2个字节记录字符串的长度：如果列的`最大长度小于或等于255字节`，则只使用1个字节表示，否则使用2个字节表表示。
    VARCHAR节省了存储空间，所以对性能也有帮助。但是由于行是变长的，在UPDATE可能使得行变得比原来更长，这就需要做额外的工作。如果一个行占用的空间增长，并且在页内没有更多的存储空间可以存储。不同的存储引擎对这个解决方法不同，MyISAM会将行拆分成不同的片段存储，InnoDB则需要分裂页来使行可以放进页内。
- CHAR
    当存储CHAR值的时候，MySQL会删除所有的末尾空格。CHAR值会根据需要采用空格进行填充以方便比较。以下是对该行为的测试(所用mysql8.0.11)
    ![](https://brandonxcc.top/char插入语句.png)
    ![](https://brandonxcc.top/char查询语句.png)
    但是使用varchar就会保存末尾的空格
    ![](https://brandonxcc.top/varchar查询.png)
    CHAR适合存储一些很短的字符串，或者所有字符串都接近一个长度。对于经常变更的数据，CHAR也比VARCHAR更好，因为定长的CHAR很少产生一些碎片。对于存储一些非常短的列，char也比varchar更加有优势，比如使用char(1) 来存储只有Y和N的值，如果单个字符集只需要一个字节，但是varchar(1)则需要两个字节，因为还有一个额外记录长度的字节。

- 更大的空间并不是明智的
使用varchar(5)与使用varchar(200)来存储'hello'所用的空间是一致的。但是更长的列会消耗更多的内存，因为MySQL通常会分配固定大小的内存块来保存内部值。尤其是使用内存临时表进行排序或操作时会特别糟糕。

## 日期和时间类型
MySQL可以使用很多类型来保存时间和时间值。MySQL能存储的最小时间粒度为秒。但是MySQL也可以使用微秒级的粒度进行临时运算。
- DATETIME
    这个类型能保存大范围的值，从1001年到9999年，精度为秒。把日期和时间封装到格式为YYYYMMDDHHMMSS的整数中，与时区无关。使用8个字节的存储空间。
- TIMESTAMP
    与unix时间戳相同。TIMESTAMP只使用4个字节的存储空间，表示的范围比DATETIME要小得多。

## 位数据类型
使用紧凑的位存储数据。所有位数据，不管底层存储格式和处理方式如何，从技术上来说都是字符串类型。
- BIT
使用BIT列在一列中存储一个或者多个true/false值，BIT(1)定义一个包含单个位的字段，BIT(2)存储2个位，依次类推。BIT列列的最大长度是64个位。
MySQL把BIT当作字符串类型，而不是数据类型。当检索BIT(1)的值的时候，结果是一个包含二进制0或者1的值的字符串。而不是ASCII码的"0"或者"1"。在数字上下文检索的时候，结果是将位字符串转换成数字。
- SET
如果需要保存很多的true/false的值，可以考虑合并这些列到一个SET数据类型中，他在MySQL内部是以一系列打包的位的集合来表示的。使用FIND_IN_SET()和FIELD()这样的函数，方便在查询中使用。他的主要的缺点是改变列的定义的代价比较高：需要ALTER TABLE。
## 选择标识符

## 特殊类型数据

# MySQL schema设计中的陷阱